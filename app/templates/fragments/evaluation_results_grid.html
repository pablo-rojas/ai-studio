{% macro results_hidden_fields(query, page=None) -%}
{% set filter_correct_value = "" %}
{% if query.filter_correct is sameas true %}
  {% set filter_correct_value = "true" %}
{% elif query.filter_correct is sameas false %}
  {% set filter_correct_value = "false" %}
{% endif %}
{% if page is not none %}
<input type="hidden" name="page" value="{{ page }}">
{% endif %}
<input type="hidden" name="page_size" value="{{ query.page_size }}">
<input type="hidden" name="sort_by" value="{{ query.sort_by }}">
<input type="hidden" name="sort_order" value="{{ query.sort_order }}">
<input type="hidden" name="filter_correct" value="{{ filter_correct_value }}">
<input type="hidden" name="filter_class" value="{{ query.filter_class or '' }}">
<input type="hidden" name="filter_subset" value="{{ query.filter_subset or '' }}">
{%- endmacro %}

<section id="evaluation-results-grid" class="space-y-4">
  <form
    hx-get="/api/evaluation/{{ project_id }}/{{ experiment.id }}/results"
    hx-target="#evaluation-results-grid"
    hx-swap="outerHTML"
    class="grid grid-cols-1 gap-3 rounded-lg border border-slate-200 bg-slate-50 p-3 dark:border-slate-700 dark:bg-slate-900/50 lg:grid-cols-6"
  >
    <input type="hidden" name="page" value="1">

    <label class="space-y-1">
      <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Result</span>
      <select
        name="filter_correct"
        class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
      >
        <option value="" {% if results_query.filter_correct is none %}selected{% endif %}>All</option>
        <option value="true" {% if results_query.filter_correct is sameas true %}selected{% endif %}>Correct</option>
        <option value="false" {% if results_query.filter_correct is sameas false %}selected{% endif %}>Incorrect</option>
      </select>
    </label>

    <label class="space-y-1">
      <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Subset</span>
      <select
        name="filter_subset"
        class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
      >
        <option value="" {% if not results_query.filter_subset %}selected{% endif %}>All subsets</option>
        {% for subset in subset_options %}
        <option value="{{ subset.name }}" {% if results_query.filter_subset == subset.name %}selected{% endif %}>
          {{ subset.label }}
        </option>
        {% endfor %}
      </select>
    </label>

    <label class="space-y-1">
      <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Class</span>
      <select
        name="filter_class"
        class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
      >
        <option value="" {% if not results_query.filter_class %}selected{% endif %}>All classes</option>
        {% for class_name in class_options %}
        <option value="{{ class_name }}" {% if results_query.filter_class == class_name %}selected{% endif %}>
          {{ class_name }}
        </option>
        {% endfor %}
      </select>
    </label>

    <label class="space-y-1">
      <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Sort By</span>
      <select
        name="sort_by"
        class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
      >
        <option value="filename" {% if results_query.sort_by == "filename" %}selected{% endif %}>Filename</option>
        <option value="confidence" {% if results_query.sort_by == "confidence" %}selected{% endif %}>Confidence</option>
        <option value="error" {% if results_query.sort_by == "error" %}selected{% endif %}>Error</option>
      </select>
    </label>

    <label class="space-y-1">
      <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Order</span>
      <select
        name="sort_order"
        class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
      >
        <option value="asc" {% if results_query.sort_order == "asc" %}selected{% endif %}>Ascending</option>
        <option value="desc" {% if results_query.sort_order == "desc" %}selected{% endif %}>Descending</option>
      </select>
    </label>

    <div class="grid grid-cols-2 gap-2">
      <label class="space-y-1">
        <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Page Size</span>
        <select
          name="page_size"
          class="w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
        >
          {% for option in [25, 50, 100] %}
          <option value="{{ option }}" {% if results_query.page_size == option %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
      <button
        type="submit"
        class="self-end rounded-md bg-slate-900 px-3 py-1.5 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
      >
        Apply
      </button>
    </div>
  </form>

  {% if results_page["total_items"] > 0 %}
    {% set start_index = ((results_page["page"] - 1) * results_page["page_size"]) + 1 %}
    {% set end_index = start_index + (results_page["items"] | length) - 1 %}
    <form id="evaluation-result-detail-query" class="hidden">
      {{ results_hidden_fields(results_query, results_page["page"]) }}
    </form>

    <p class="text-sm text-slate-600 dark:text-slate-300">
      Showing {{ start_index }}-{{ end_index }} of {{ results_page["total_items"] }} predictions
    </p>

    <div class="dataset-image-grid grid gap-3">
      {% for item in results_page["items"] %}
      <button
        type="button"
        @click="detailOpen = true"
        hx-get="/api/evaluation/{{ project_id }}/{{ experiment.id }}/results/{{ item.filename | urlencode }}/info"
        hx-target="#evaluation-result-detail"
        hx-swap="innerHTML"
        hx-include="#evaluation-result-detail-query"
        class="overflow-hidden rounded-lg border {% if item.correct %}border-emerald-300{% else %}border-rose-300{% endif %} bg-slate-50 text-left transition hover:border-blue-400 hover:shadow-sm dark:bg-slate-950/60"
      >
        <div class="h-32 overflow-hidden bg-slate-100 dark:bg-slate-950">
          <img
            src="/api/datasets/{{ project_id }}/thumbnails/{{ item.filename }}"
            alt="{{ item.filename }}"
            loading="lazy"
            class="h-full w-full object-contain"
          >
        </div>
        <div class="space-y-1 p-2">
          <div class="flex items-start justify-between gap-2">
            <p class="truncate text-xs font-medium text-slate-900 dark:text-slate-100">{{ item.filename }}</p>
            <span class="rounded-full px-2 py-0.5 font-medium {% if item.correct %}bg-emerald-100 text-emerald-800 dark:bg-emerald-500/20 dark:text-emerald-200{% else %}bg-rose-100 text-rose-800 dark:bg-rose-500/20 dark:text-rose-200{% endif %}">
              {% if item.correct %}Correct{% else %}Incorrect{% endif %}
            </span>
          </div>
          <div class="flex flex-wrap items-center gap-1">
            <span class="inline-flex rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-700 dark:bg-slate-800 dark:text-slate-200">
              {{ item.subset }}
            </span>
          </div>
        </div>
      </button>
      {% endfor %}
    </div>

    {% set has_prev = results_page["page"] > 1 %}
    {% set has_next = results_page["total_pages"] > 0 and results_page["page"] < results_page["total_pages"] %}
    <div class="flex flex-wrap items-center justify-between gap-2">
      <form
        hx-get="/api/evaluation/{{ project_id }}/{{ experiment.id }}/results"
        hx-target="#evaluation-results-grid"
        hx-swap="outerHTML"
        class="flex items-center gap-2"
      >
        {{ results_hidden_fields(results_query) }}
        <button
          type="submit"
          name="page"
          value="{{ results_page["page"] - 1 }}"
          {% if not has_prev %}disabled{% endif %}
          class="rounded-md border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-700 transition enabled:hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-40 dark:border-slate-700 dark:text-slate-300 dark:enabled:hover:bg-slate-800"
        >
          Previous
        </button>
        <button
          type="submit"
          name="page"
          value="{{ results_page["page"] + 1 }}"
          {% if not has_next %}disabled{% endif %}
          class="rounded-md border border-slate-300 px-3 py-1.5 text-sm font-medium text-slate-700 transition enabled:hover:bg-slate-100 disabled:cursor-not-allowed disabled:opacity-40 dark:border-slate-700 dark:text-slate-300 dark:enabled:hover:bg-slate-800"
        >
          Next
        </button>
      </form>

      <p class="text-xs text-slate-500 dark:text-slate-400">
        Page {{ results_page["page"] }} of {{ results_page["total_pages"] if results_page["total_pages"] else 1 }}
      </p>
    </div>
  {% else %}
  <div class="rounded-lg border border-dashed border-slate-300 p-8 text-center dark:border-slate-700">
    <p class="text-sm font-medium text-slate-700 dark:text-slate-300">No per-image results available.</p>
    <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">Run evaluation or adjust filters to populate the grid.</p>
  </div>
  {% endif %}
</section>
