<section id="export-page-root">
  {% if not dataset %}
  <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 p-8 text-center dark:border-slate-700 dark:bg-slate-900/40">
    <p class="text-base font-medium text-slate-900 dark:text-slate-100">No dataset imported.</p>
    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Import a dataset and train a completed experiment before exporting.</p>
    <a
      href="/projects/{{ project_id }}/dataset"
      class="mt-4 inline-flex rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
    >
      Go to Dataset Page
    </a>
  </div>
  {% else %}
  <div class="grid grid-cols-1 gap-4 xl:grid-cols-[260px_1fr]">
    <aside class="space-y-4 rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900">
      <div class="space-y-1">
        <h2 class="text-sm font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Exports</h2>
        <p class="text-xs text-slate-500 dark:text-slate-400">Select an export to inspect validation and download.</p>
      </div>

      <section id="export-list" class="space-y-2">
        {% if exports %}
          {% for export in exports %}
          {% set is_selected = selected_export_id == export.id %}
          {% set status = export.status %}
          {% if status == "completed" %}
            {% set status_classes = "bg-emerald-100 text-emerald-800 dark:bg-emerald-500/20 dark:text-emerald-200" %}
          {% elif status in ("pending", "running") %}
            {% set status_classes = "bg-sky-100 text-sky-800 dark:bg-sky-500/20 dark:text-sky-200" %}
          {% elif status == "failed" %}
            {% set status_classes = "bg-rose-100 text-rose-800 dark:bg-rose-500/20 dark:text-rose-200" %}
          {% else %}
            {% set status_classes = "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200" %}
          {% endif %}
          <button
            type="button"
            hx-get="/api/export/{{ project_id }}/{{ export.id }}"
            hx-target="#export-page-root"
            hx-swap="outerHTML"
            hx-push-url="/projects/{{ project_id }}/export?experiment_id={{ export.experiment_id }}&export_id={{ export.id }}"
            class="w-full rounded-lg border p-3 text-left text-sm transition {% if is_selected %}border-blue-500 bg-blue-50 dark:border-blue-400 dark:bg-blue-500/10{% else %}border-slate-200 bg-white hover:border-slate-300 dark:border-slate-800 dark:bg-slate-900 dark:hover:border-slate-700{% endif %}"
          >
            <div class="flex items-center justify-between gap-2">
              <p class="truncate font-medium text-slate-900 dark:text-slate-100">{{ export.format | upper }} · {{ export.id }}</p>
              <span class="rounded-full px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide {{ status_classes }}">
                {{ status }}
              </span>
            </div>
            <p class="mt-1 truncate text-xs text-slate-500 dark:text-slate-400">
              {{ experiment_name_by_id.get(export.experiment_id, export.experiment_id) }}
            </p>
            {% if export.output_size_mb is not none %}
            <p class="mt-2 text-xs text-slate-600 dark:text-slate-300">{{ "%.3f"|format(export.output_size_mb) }} MB</p>
            {% else %}
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">Output size: —</p>
            {% endif %}
          </button>
          {% endfor %}
        {% else %}
        <p class="rounded-lg border border-dashed border-slate-300 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
          No exports yet. Create one from the workspace.
        </p>
        {% endif %}
      </section>
    </aside>

    <div class="min-w-0 space-y-4">
      <article id="export-workspace" class="rounded-xl border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900">
        <header class="border-b border-slate-200 px-4 py-3 dark:border-slate-800">
          <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Create Export</h2>
        </header>
        <div class="space-y-4 p-4">
          {% if completed_experiments %}
          <form
            hx-post="/api/export/{{ project_id }}"
            hx-target="#export-page-root"
            hx-swap="outerHTML"
            class="space-y-4"
          >
            <input type="hidden" name="format" value="onnx">

            <label class="block space-y-1">
              <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Experiment</span>
              <select
                name="experiment_id"
                hx-get="/api/export/{{ project_id }}"
                hx-target="#export-page-root"
                hx-swap="outerHTML"
                hx-trigger="change"
                class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
              >
                {% for experiment in completed_experiments %}
                <option value="{{ experiment.id }}" {% if selected_experiment_id == experiment.id %}selected{% endif %}>{{ experiment.name }}</option>
                {% endfor %}
              </select>
            </label>

            <label class="block space-y-1">
              <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Checkpoint</span>
              <select
                name="checkpoint"
                class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
              >
                {% if checkpoints %}
                  {% for checkpoint in checkpoints %}
                  <option value="{{ checkpoint }}" {% if form_defaults.checkpoint == checkpoint %}selected{% endif %}>{{ checkpoint }}</option>
                  {% endfor %}
                {% else %}
                <option value="{{ form_defaults.checkpoint }}">{{ form_defaults.checkpoint }}</option>
                {% endif %}
              </select>
            </label>

            <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
              <label class="space-y-1">
                <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Opset</span>
                <input
                  type="number"
                  name="options.opset_version"
                  value="{{ form_defaults.opset_version }}"
                  min="13"
                  max="21"
                  class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
                >
              </label>
              <label class="space-y-1">
                <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Input Height</span>
                <input
                  type="number"
                  name="input_height"
                  value="{{ form_defaults.input_height }}"
                  min="1"
                  max="8192"
                  class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
                >
              </label>
              <label class="space-y-1">
                <span class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Input Width</span>
                <input
                  type="number"
                  name="input_width"
                  value="{{ form_defaults.input_width }}"
                  min="1"
                  max="8192"
                  class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
                >
              </label>
            </div>

            <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
              <label class="inline-flex items-center gap-2 rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 dark:border-slate-700 dark:text-slate-200">
                <input type="hidden" name="dynamic_batch" value="false">
                <input
                  type="checkbox"
                  name="dynamic_batch"
                  value="true"
                  {% if form_defaults.dynamic_batch %}checked{% endif %}
                  class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-500 dark:border-slate-700 dark:bg-slate-950"
                >
                Dynamic batch
              </label>

              <label class="inline-flex items-center gap-2 rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 dark:border-slate-700 dark:text-slate-200">
                <input type="hidden" name="options.simplify" value="false">
                <input
                  type="checkbox"
                  name="options.simplify"
                  value="true"
                  {% if form_defaults.simplify %}checked{% endif %}
                  class="h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-500 dark:border-slate-700 dark:bg-slate-950"
                >
                Simplify graph
              </label>
            </div>

            <div class="flex items-center">
              <button
                type="submit"
                class="rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
              >
                Export ONNX
              </button>
            </div>
          </form>
          {% else %}
          <p class="rounded-lg border border-dashed border-slate-300 bg-slate-50 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
            No completed experiments available. Finish training before exporting.
          </p>
          {% endif %}
        </div>
      </article>

      {% if selected_export %}
      {% set detail_status = selected_export.status %}
      {% if detail_status == "completed" %}
        {% set detail_status_classes = "bg-emerald-100 text-emerald-800 dark:bg-emerald-500/20 dark:text-emerald-200" %}
      {% elif detail_status in ("pending", "running") %}
        {% set detail_status_classes = "bg-sky-100 text-sky-800 dark:bg-sky-500/20 dark:text-sky-200" %}
      {% elif detail_status == "failed" %}
        {% set detail_status_classes = "bg-rose-100 text-rose-800 dark:bg-rose-500/20 dark:text-rose-200" %}
      {% else %}
        {% set detail_status_classes = "bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-200" %}
      {% endif %}
      <article data-export-detail class="rounded-xl border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-900">
        <header class="flex flex-wrap items-center justify-between gap-2 border-b border-slate-200 px-4 py-3 dark:border-slate-800">
          <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Export Detail</h2>
          <span class="rounded-full px-2 py-0.5 text-[11px] font-medium uppercase tracking-wide {{ detail_status_classes }}">
            {{ detail_status }}
          </span>
        </header>

        <div class="space-y-4 p-4 text-sm">
          <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Experiment</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">
                {{ experiment_name_by_id.get(selected_export.experiment_id, selected_export.experiment_id) }}
              </p>
            </div>
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Checkpoint</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">{{ selected_export.checkpoint }}</p>
            </div>
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Format</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">{{ selected_export.format | upper }}</p>
            </div>
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Opset</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">{{ selected_export.options.opset_version }}</p>
            </div>
          </div>

          <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
            <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Input Shape (NCHW)</p>
            <p class="font-medium text-slate-900 dark:text-slate-100">{{ selected_export.options.input_shape | join(" × ") }}</p>
          </div>

          <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Dynamic Batch</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">
                {% if selected_export.options.dynamic_axes %}Enabled{% else %}Disabled{% endif %}
              </p>
            </div>
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Simplified</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">
                {% if selected_export.options.simplify %}Yes{% else %}No{% endif %}
              </p>
            </div>
          </div>

          <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
            <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Validation</p>
            {% if selected_export.validation %}
            <p class="font-medium text-slate-900 dark:text-slate-100">
              {% if selected_export.validation.passed %}Passed{% else %}Failed{% endif %}
            </p>
            <p class="text-xs text-slate-600 dark:text-slate-300">
              max diff {{ "%.6g"|format(selected_export.validation.max_diff) }} · mean diff {{ "%.6g"|format(selected_export.validation.mean_diff) }}
            </p>
            {% else %}
            <p class="font-medium text-slate-900 dark:text-slate-100">Not available</p>
            {% endif %}
          </div>

          <div class="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Output File</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">{{ selected_export.output_file or "—" }}</p>
            </div>
            <div class="rounded-md border border-slate-200 bg-slate-50 px-3 py-2 dark:border-slate-700 dark:bg-slate-900/40">
              <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Output Size</p>
              <p class="font-medium text-slate-900 dark:text-slate-100">
                {% if selected_export.output_size_mb is not none %}{{ "%.3f"|format(selected_export.output_size_mb) }} MB{% else %}—{% endif %}
              </p>
            </div>
          </div>

          {% if selected_export.error %}
          <p class="rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-800 dark:border-rose-900 dark:bg-rose-950/30 dark:text-rose-200">
            {{ selected_export.error }}
          </p>
          {% endif %}

          <div class="flex flex-wrap items-center gap-2">
            {% if selected_export.output_file %}
            <a
              href="/api/export/{{ project_id }}/{{ selected_export.id }}/download"
              class="rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
            >
              Download ONNX
            </a>
            {% endif %}
            <button
              type="button"
              hx-delete="/api/export/{{ project_id }}/{{ selected_export.id }}"
              hx-target="#export-page-root"
              hx-swap="outerHTML"
              class="rounded-md border border-rose-300 px-4 py-2 text-sm font-medium text-rose-700 hover:bg-rose-50 dark:border-rose-700 dark:text-rose-200 dark:hover:bg-rose-900/30"
            >
              Delete Export
            </button>
          </div>
        </div>
      </article>
      {% else %}
      <article class="rounded-xl border border-dashed border-slate-300 bg-slate-50 p-6 text-center dark:border-slate-700 dark:bg-slate-900/40">
        <p class="text-base font-medium text-slate-900 dark:text-slate-100">No export selected.</p>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Create a new export or choose one from the list.</p>
      </article>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>
