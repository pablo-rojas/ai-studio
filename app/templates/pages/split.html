{% extends "base.html" %}
{% block title %}Split{% endblock %}

{% block content %}
<section
  x-data="splitPageState({
    previewUrl: '/api/splits/{{ project.id }}/preview',
    hasDataset: {{ "true" if dataset else "false" }},
    existingSplitNames: {{ (dataset.split_names if dataset else []) | tojson }},
  })"
  x-on:split-created.window="handleCreateSuccess($event.detail && $event.detail.name ? $event.detail.name : splitName)"
  class="space-y-6"
>
  <div class="flex flex-wrap items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-900 dark:text-slate-100">Splits</h1>
      <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">
        Configure immutable train/val/test splits for <span class="font-medium">{{ project.name }}</span>.
      </p>
    </div>
    <button
      type="button"
      @click="openCreateModal()"
      {% if not dataset %}disabled{% endif %}
      class="inline-flex items-center rounded-md px-4 py-2 text-sm font-medium transition {% if dataset %}bg-slate-900 text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300{% else %}cursor-not-allowed border border-slate-300 bg-slate-200 text-slate-500 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-500{% endif %}"
    >
      New Split
    </button>
  </div>

  {% if dataset %}
  <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
    <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900">
      <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Images</p>
      <p class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-100">{{ dataset.image_stats.num_images }}</p>
    </div>
    <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900">
      <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Classes</p>
      <p class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-100">{{ dataset.classes | length }}</p>
    </div>
    <div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-900">
      <p class="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">Saved Splits</p>
      <p class="mt-1 text-2xl font-semibold text-slate-900 dark:text-slate-100">{{ splits | length }}</p>
    </div>
  </div>

  {% include "fragments/split_list.html" %}
  {% else %}
  <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50 p-8 text-center dark:border-slate-700 dark:bg-slate-900/40">
    <p class="text-base font-medium text-slate-900 dark:text-slate-100">No dataset imported.</p>
    <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Import a dataset before creating splits.</p>
    <a
      href="/projects/{{ project.id }}/dataset"
      class="mt-4 inline-flex rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
    >
      Go to Dataset Page
    </a>
  </div>
  {% endif %}

  <div
    x-show="createOpen"
    x-cloak
    class="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/60 p-4"
    @click.self="closeCreateModal()"
  >
    <div class="w-full max-w-3xl rounded-xl bg-white p-6 shadow-xl dark:bg-slate-900 dark:shadow-slate-950/40">
      <div class="mb-4 flex items-start justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Create Split</h2>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Ratios always sum to 100% and new splits are immutable.</p>
        </div>
        <button
          type="button"
          class="rounded-md border border-slate-300 px-2 py-1 text-xs font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800"
          @click="closeCreateModal()"
        >
          Close
        </button>
      </div>

      <form
        hx-post="/api/splits/{{ project.id }}"
        hx-target="#split-list"
        hx-swap="outerHTML"
        hx-disabled-elt="button, input, select"
        class="grid grid-cols-1 gap-6 lg:grid-cols-2"
      >
        <div class="space-y-4">
          <label class="block space-y-1">
            <span class="text-sm font-medium text-slate-900 dark:text-slate-100">Name</span>
            <input
              type="text"
              name="name"
              x-model.trim="splitName"
              required
              maxlength="80"
              placeholder="80-10-10"
              class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
            >
          </label>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Ratios</h3>
              <p class="text-xs font-medium text-slate-500 dark:text-slate-400">Total: <span x-text="totalPercent"></span>%</p>
            </div>

            <label class="block space-y-1">
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-slate-700 dark:text-slate-300">Train</span>
                <span class="text-slate-600 dark:text-slate-400" x-text="`${ratios.train}%`"></span>
              </div>
              <input
                id="split-ratio-train"
                type="range"
                min="0"
                max="100"
                step="1"
                :value="ratios.train"
                @input="updateRatio('train', $event.target.valueAsNumber)"
                class="w-full accent-slate-900 dark:accent-slate-100"
              >
            </label>

            <label class="block space-y-1">
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-slate-700 dark:text-slate-300">Val</span>
                <span class="text-slate-600 dark:text-slate-400" x-text="`${ratios.val}%`"></span>
              </div>
              <input
                id="split-ratio-val"
                type="range"
                min="0"
                max="100"
                step="1"
                :value="ratios.val"
                @input="updateRatio('val', $event.target.valueAsNumber)"
                class="w-full accent-slate-900 dark:accent-slate-100"
              >
            </label>

            <label class="block space-y-1">
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-slate-700 dark:text-slate-300">Test</span>
                <span class="text-slate-600 dark:text-slate-400" x-text="`${ratios.test}%`"></span>
              </div>
              <input
                id="split-ratio-test"
                type="range"
                min="0"
                max="100"
                step="1"
                :value="ratios.test"
                @input="updateRatio('test', $event.target.valueAsNumber)"
                class="w-full accent-slate-900 dark:accent-slate-100"
              >
            </label>
          </div>

          <label class="block space-y-1">
            <span class="text-sm font-medium text-slate-900 dark:text-slate-100">Seed</span>
            <input
              id="split-seed-input"
              type="number"
              min="0"
              step="1"
              x-model.number="seed"
              @input.debounce.300ms="refreshPreview()"
              class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100"
            >
          </label>
        </div>

        <div class="space-y-4">
          <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Preview</h3>
          {% set preview = none %}
          {% include "fragments/split_preview.html" %}
        </div>

        <input type="hidden" name="train" :value="ratioDecimal('train')">
        <input type="hidden" name="val" :value="ratioDecimal('val')">
        <input type="hidden" name="test" :value="ratioDecimal('test')">
        <input type="hidden" name="seed" :value="normalizedSeed()">

        <div class="col-span-full flex justify-end gap-2 pt-1">
          <button
            type="button"
            class="rounded-md border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800"
            @click="closeCreateModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-700 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-slate-300"
          >
            Create
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  function splitPageState(config) {
    return {
      createOpen: false,
      hasDataset: Boolean(config.hasDataset),
      previewUrl: config.previewUrl,
      existingSplitNames: Array.isArray(config.existingSplitNames)
        ? [...config.existingSplitNames]
        : [],
      splitName: "80-10-10",
      seed: 42,
      ratios: { train: 80, val: 10, test: 10 },

      get totalPercent() {
        return this.ratios.train + this.ratios.val + this.ratios.test;
      },

      openCreateModal() {
        if (!this.hasDataset) {
          return;
        }
        this.resetForm();
        this.createOpen = true;
        this.$nextTick(() => this.refreshPreview());
      },

      closeCreateModal() {
        this.createOpen = false;
      },

      resetForm() {
        this.ratios = { train: 80, val: 10, test: 10 };
        this.seed = 42;
        this.splitName = this.nextAvailableSplitName("80-10-10");
      },

      nextAvailableSplitName(baseName) {
        if (!this.existingSplitNames.includes(baseName)) {
          return baseName;
        }

        let index = 2;
        while (this.existingSplitNames.includes(`${baseName}-${index}`)) {
          index += 1;
        }
        return `${baseName}-${index}`;
      },

      ratioDecimal(key) {
        return (this.ratios[key] / 100).toFixed(2);
      },

      normalizedSeed() {
        const numericSeed = Number(this.seed);
        if (!Number.isFinite(numericSeed) || numericSeed < 0) {
          return "0";
        }
        return String(Math.trunc(numericSeed));
      },

      updateRatio(changed, rawValue) {
        const value = Math.max(0, Math.min(100, Math.round(rawValue)));
        this.ratios[changed] = value;

        const otherKeys = ["train", "val", "test"].filter((key) => key !== changed);
        const remaining = 100 - value;
        const currentOtherTotal = this.ratios[otherKeys[0]] + this.ratios[otherKeys[1]];

        if (currentOtherTotal <= 0) {
          this.ratios[otherKeys[0]] = remaining;
          this.ratios[otherKeys[1]] = 0;
        } else {
          const first = Math.round((this.ratios[otherKeys[0]] / currentOtherTotal) * remaining);
          this.ratios[otherKeys[0]] = first;
          this.ratios[otherKeys[1]] = remaining - first;
        }

        this.refreshPreview();
      },

      refreshPreview() {
        if (!this.hasDataset || !window.htmx) {
          return;
        }
        const params = new URLSearchParams({
          train: this.ratioDecimal("train"),
          val: this.ratioDecimal("val"),
          test: this.ratioDecimal("test"),
          seed: this.normalizedSeed(),
        });
        window.htmx.ajax("GET", `${this.previewUrl}?${params.toString()}`, {
          target: "#split-preview",
          swap: "outerHTML",
          headers: { "HX-Request": "true" },
        });
      },

      handleCreateSuccess(createdName = this.splitName) {
        if (createdName && !this.existingSplitNames.includes(createdName)) {
          this.existingSplitNames.push(createdName);
        }
        this.createOpen = false;
      },
    };
  }
</script>
{% endblock %}
